<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æˆ‘çš„æ—…è¡Œæ—¶é—´çº¿</title>
  <meta name="description" content="æŒ‰æ—¶é—´è®°å½•æˆ‘çš„æ—…è¡Œè¶³è¿¹ï¼šæœˆä»½ã€åœ°åŒºä¸ç…§ç‰‡ã€‚"/>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='80'>ğŸ—ºï¸</text></svg>">
  <style>
    :root{
      --bg:#0d1117; --bg2:#0a0f1a; --card:#111827; --fg:#e6edf3; --muted:#9fb0c9;
      --accent:#7aa2ff; --accent2:#9fe6a0; --border:rgba(255,255,255,.08);
      --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.35); --focus:0 0 0 3px rgba(122,162,255,.35);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      color:var(--fg);
      background:
        radial-gradient(900px 600px at 20% 0%, #182147 0%, transparent 60%),
        radial-gradient(800px 500px at 100% 0%, #1b2a58 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      line-height:1.75;
    }
    a{color:var(--accent); text-decoration:none}
    a:focus-visible, button:focus-visible, input:focus-visible, select:focus-visible{outline:none; box-shadow:var(--focus); border-radius:10px}
    img{max-width:100%; display:block}
    .container{max-width:980px; margin:0 auto; padding:0 20px}
    .card{background:linear-gradient(180deg,#111a33,#0f172b); border:1px solid var(--border);
          border-radius:var(--radius); box-shadow:var(--shadow)}
    .btn{display:inline-block; padding:8px 12px; border:1px solid var(--border); border-radius:12px; background:#0f1830; color:#d9e2ef; cursor:pointer}
    .btn.ghost{background:#0c1329}
    .chip{padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#101a33; color:#d8e3f3; cursor:pointer}
    .chip.active{background:#1a2a4a}

    .skip{position:absolute; left:-9999px}
    .skip:focus{left:20px; top:12px; background:#121a2f; padding:8px 12px; border-radius:10px; z-index:1100}

    header{position:sticky; top:0; z-index:50; backdrop-filter: blur(8px); background: rgba(8,12,24,.6); border-bottom:1px solid var(--border)}
    .nav{display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    .logo{width:28px; height:28px; display:grid; place-items:center; background:linear-gradient(135deg,#7aa2ff,#9fe6a0); color:#0b1020; border-radius:8px; font-weight:900}

    .hero{padding:80px 0 20px}
    .hero h1{margin:0 0 8px; font-size: clamp(28px, 6vw, 48px)}
    .hero p{margin:0; color:var(--muted)}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:16px 0}
    .subbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:-8px 0 10px 0}
    .input{padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:#0f1528; color:#dbe6f7}

    /* æ¨ªå‘æ—¶é—´è½´ */
    .year-rail-wrap{position:sticky; top:64px; z-index:5; background:rgba(8,12,24,.7); backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border)}
    .year-rail{display:flex; gap:8px; overflow-x:auto; padding:10px 0}
    .year-pill{white-space:nowrap; padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:#0f172b; color:#cfe1ff; cursor:pointer}
    .year-pill.active{background:#1a2a4a}

    /* çºµå‘æ—¶é—´çº¿ */
    .timeline{position:relative; padding:6px 0 30px}
    .timeline::before{content:''; position:absolute; left:18px; top:0; bottom:0; width:2px; background:linear-gradient(180deg,#27325a,#1a2244)}
    .year{position:relative; margin:16px 0 8px; display:inline-block; padding:6px 12px; border:1px solid var(--border); border-radius:999px; background:#0f172b; color:#cfe1ff}
    .entry{position:relative; margin:12px 0 16px; padding:14px 14px 12px 54px; border:1px solid var(--border)}
    .entry::before{content:''; position:absolute; left:10px; top:18px; width:16px; height:16px; border-radius:50%; background:linear-gradient(135deg,#7aa2ff,#9fe6a0); box-shadow:0 0 0 4px rgba(122,162,255,.15)}
    .entry h3{margin:0 0 6px; font-size:20px}
    .meta{color:#9fb0c9; font-size:13px; margin-bottom:8px}
    .thumb{overflow:hidden; border-radius:12px; border:1px solid var(--border); aspect-ratio: 16/10; background:#0e1630}
    .thumb img{width:100%; height:100%; object-fit:cover}

    dialog{border:none; padding:0; border-radius:14px; overflow:hidden; background:#0b0f1c}
    .lightbox img{display:block; width:100%; height:auto}
    .lightbox .bar{display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background:#0f172b; border-bottom:1px solid var(--border)}
    .close{background:#0e1630; color:#e6edf3; border:1px solid var(--border); border-radius:8px; padding:6px 10px; cursor:pointer}

    footer{padding:28px 0; color:#9fb0c9; border-top:1px solid var(--border)}
  </style>
</head>
<body>
  <a class="skip" href="#main">è·³åˆ°ä¸»å†…å®¹</a>

  <header>
    <div class="container nav" aria-label="ä¸»å¯¼èˆª">
      <div class="brand"><div class="logo" aria-hidden="true">âœ¦</div><span>æˆ‘çš„æ—…è¡Œæ—¶é—´çº¿</span></div>
      <nav aria-label="è¾…åŠ©é“¾æ¥">
        <a class="btn" id="exportBtn" title="å¯¼å‡ºæ•°æ®">å¯¼å‡º</a>
        <label class="btn ghost" for="importFile" title="å¯¼å…¥æ•°æ®">å¯¼å…¥</label>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
      </nav>
    </div>
  </header>

  <main id="main">
    <section class="hero">
      <div class="container">
        <h1>æŒ‰æ—¶é—´è®°å½•æˆ‘çš„æ—…è¡Œ</h1>
        <p>ä»…åŒºåˆ†â€œå›½å†… / å›½å¤–â€ã€‚å›½å†…æ”¯æŒæŒ‰çœä»½ç²¾ç¡®ç­›é€‰ï¼›ç‚¹å‡»ä¸‹æ–¹æ—¶é—´è½´å¯è·³è½¬åˆ°å¯¹åº”å¹´ä»½æˆ–æœˆä»½ã€‚</p>
      </div>
    </section>

    <!-- å·¥å…·æ  -->
    <section class="container">
      <div class="toolbar">
        <strong>å¹´ä»½ï¼š</strong>
        <select id="yearSel" class="input">
          <option value="all">å…¨éƒ¨å¹´ä»½</option>
        </select>

        <strong>èŒƒå›´ï¼š</strong>
        <div id="scopeWrap" style="display:flex; gap:8px; flex-wrap:wrap"></div>

        <input id="q" class="input" style="flex:1; min-width:200px" placeholder="æœç´¢ï¼šæ ‡é¢˜ / å¤‡æ³¨ / çœä»½ / å›½å®¶"/>
      </div>

      <!-- ä»…åœ¨ scope=å›½å†… æ—¶æ˜¾ç¤º -->
      <div class="subbar" id="provBar" hidden>
        <strong>çœä»½ï¼š</strong>
        <div id="provWrap" style="display:flex; gap:8px; flex-wrap:wrap"></div>
      </div>
    </section>

    <!-- æ¨ªå‘æ—¶é—´è½´ -->
    <div class="year-rail-wrap">
      <div class="container">
        <div id="yearRail" class="year-rail" role="tablist" aria-label="å¹´ä»½æ—¶é—´è½´">
          <!-- JS æ¸²æŸ“å¹´ä»½ä¸æœˆä»½ pill -->
        </div>
      </div>
    </div>

    <!-- çºµå‘æ—¶é—´çº¿ -->
    <section class="container timeline card" id="timeline" aria-label="æ—…è¡Œæ—¶é—´çº¿"></section>

    <!-- å›¾ç‰‡ç¯ç®± -->
    <dialog class="lightbox" id="dlg" aria-label="å›¾ç‰‡é¢„è§ˆ">
      <div class="bar">
        <span>æŒ‰ Esc å…³é—­ï¼›å·¦å³æ–¹å‘é”®åˆ‡æ¢</span>
        <button class="close" id="closeBtn" aria-label="å…³é—­é¢„è§ˆ">å…³é—­</button>
      </div>
      <img id="big" alt="å›¾ç‰‡é¢„è§ˆ">
    </dialog>
  </main>

  <footer>
    <div class="container" style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap">
      <span>Â© <span id="year"></span> ä½ çš„åå­—</span>
      <span>æ—¶é—´çº¿ Â· å›½å†…/å›½å¤– + çœä»½ç­›é€‰ Â· å¹´æœˆè·³è½¬</span>
    </div>
  </footer>

  <script>
    // å¹´ä»½
    document.getElementById('year').textContent = new Date().getFullYear();

    // ==== 1) æ—…è¡Œæ•°æ®ï¼ˆå·²ä¿®æ”¹ date åªç²¾ç¡®åˆ°æœˆä»½ï¼‰====
    const TRIPS = [
      { id:"2024-chengdu", date:"2024-10", title:"æˆéƒ½çš„æ…¢ä¸‹åˆ", scope:"å›½å†…", province:"å››å·", cover:"assets/chengdu.jpg", gallery:["assets/chengdu1.jpg"], note:"åœ¨å··å£é—»åˆ°èŠ±æ¤’ä¸é›¨å‘³ã€‚" },
      { id:"2024-qingdao", date:"2024-07", title:"é’å²›æµ·é£",     scope:"å›½å†…", province:"å±±ä¸œ", cover:"assets/qingdao.jpg", gallery:["assets/qingdao1.jpg","assets/qingdao2.jpg"] },
      { id:"2023-tokyo",   date:"2023-04", title:"æ˜¥æ—¥ä¸œäº¬ä¸é•°ä»“", scope:"å›½å¤–", country:"æ—¥æœ¬", cover:"assets/tokyo.jpg", gallery:["assets/tokyo1.jpg","assets/tokyo2.jpg"] },
      { id:"2022-alps",    date:"2022-07", title:"é˜¿å°”å‘æ–¯å¾’æ­¥",   scope:"å›½å¤–", country:"ç‘å£«", cover:"assets/alps.jpg", gallery:["assets/alps1.jpg","assets/alps2.jpg","assets/alps3.jpg"] }
    ];

    // ==== 2) çŠ¶æ€ ====
    const state = { year:'all', scope:'å…¨éƒ¨', province:'å…¨éƒ¨', q:'' };

    const yearSel = document.getElementById('yearSel');
    const scopeWrap = document.getElementById('scopeWrap');
    const provBar = document.getElementById('provBar');
    const provWrap = document.getElementById('provWrap');
    const yearRail = document.getElementById('yearRail');

    // å¹´ä»½åˆ—è¡¨
    const years = Array.from(new Set(TRIPS.map(t=>t.date.slice(0,7)))).sort((a,b)=>b-a);
    years.forEach(y=>{ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt); });

    // èŒƒå›´èŠ¯ç‰‡
    ['å…¨éƒ¨','å›½å†…','å›½å¤–'].forEach(s=>{
      const b=document.createElement('button');
      b.className='chip'+(s==='å…¨éƒ¨'?' active':'');
      b.textContent=s; b.dataset.scope=s;
      scopeWrap.appendChild(b);
    });

    // çœä»½èŠ¯ç‰‡
    function buildProvinces(){
      provWrap.innerHTML='';
      const set = new Set(['å…¨éƒ¨']);
      TRIPS.filter(t=>t.scope==='å›½å†…' && t.province).forEach(t=>set.add(t.province));
      Array.from(set).forEach(p=>{
        const b=document.createElement('button');
        b.className='chip'+(p==='å…¨éƒ¨'?' active':'');
        b.textContent=p; b.dataset.province=p; provWrap.appendChild(b);
      });
    }
    buildProvinces();

    // æ¨ªå‘æ—¶é—´è½´ pills
    function buildYearRail(){
      yearRail.innerHTML='';
      years.forEach(y=>{
        const a=document.createElement('button');
        a.className='year-pill';
        a.textContent=y; a.dataset.year=y; a.setAttribute('role','tab');
        yearRail.appendChild(a);
      });
    }
    buildYearRail();

    // ==== 3) äº¤äº’ ====
    document.getElementById('q').addEventListener('input', (e)=>{ state.q=(e.target.value||'').toLowerCase().trim(); render(); });
    yearSel.addEventListener('change', ()=>{ state.year=yearSel.value; render(true); });
    scopeWrap.addEventListener('click', (e)=>{
      const btn=e.target.closest('button.chip'); if(!btn) return;
      scopeWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active'); state.scope=btn.dataset.scope;
      const showProv = state.scope==='å›½å†…';
      provBar.hidden = !showProv;
      state.province='å…¨éƒ¨';
      if(showProv){
        provWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        const first = provWrap.querySelector('[data-province="å…¨éƒ¨"]'); if(first) first.classList.add('active');
      }
      render(true);
    });
    provWrap.addEventListener('click', (e)=>{
      const btn=e.target.closest('button.chip'); if(!btn) return;
      provWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active'); state.province=btn.dataset.province;
      render(true);
    });

    // æ—¶é—´è½´ç‚¹å‡»è·³è½¬
    yearRail.addEventListener('click', (e)=>{
      const btn=e.target.closest('button.year-pill'); if(!btn) return;
      const targetYear = btn.dataset.year;
      const anchor = document.querySelector(`[data-year-anchor="${targetYear}"]`);
      if(anchor){ anchor.scrollIntoView({behavior:'smooth', block:'start'}); }
    });

    function filterTrips(list){
      return list.filter(t=>{
        const yOk = state.year==='all' || t.date.startsWith(state.year);
        const sOk = state.scope==='å…¨éƒ¨' || t.scope===state.scope;
        const pOk = !(state.scope==='å›½å†…') || state.province==='å…¨éƒ¨' || t.province===state.province;
        const hay = (t.title+' '+(t.note||'')+' '+(t.province||'')+' '+(t.country||'')).toLowerCase();
        const qOk = !state.q || hay.includes(state.q);
        return yOk && sOk && pOk && qOk;
      });
    }

    // ==== 4) æ¸²æŸ“ ====
    function render(rebuildAnchors=false){
      const wrap = document.getElementById('timeline');
      wrap.innerHTML='';
      const data = filterTrips([...TRIPS]).sort((a,b)=> b.date.localeCompare(a.date));
      if(data.length===0){
        const empty=document.createElement('p'); empty.style.color='var(--muted)'; empty.style.margin='16px';
        empty.textContent='æ²¡æœ‰åŒ¹é…çš„æ—…è¡Œè®°å½•ã€‚è¯•è¯•æ›´æ¢ç­›é€‰æˆ–å…³é”®è¯ã€‚'; wrap.appendChild(empty); return;
      }
      let curYear=null;
      data.forEach(t=>{
        const y=t.date.slice(0,7); // åªä¿ç•™åˆ°å¹´-æœˆ
        if(curYear!==y){
          curYear=y;
          const tag=document.createElement('div'); tag.className='year'; tag.textContent=y;
          tag.setAttribute('data-year-anchor', y); // ä¾›æ—¶é—´è½´è·³è½¬
          wrap.appendChild(tag);
        }
        const metaPieces = [
          `<time datetime="${t.date}">${t.date}</time>`,
          t.scope==='å›½å†…' ? `å›½å†…Â·${t.province||'æœªå¡«çœä»½'}` : `å›½å¤–${t.country ? 'Â·'+t.country : ''}`
        ];
        const art=document.createElement('article'); art.className='entry card';
        art.innerHTML = `
          <div class="meta">${metaPieces.join(' Â· ')}</div>
          <h3>${t.title}</h3>
          <div class="thumb"><img src="${t.cover||''}" alt="${t.title} å°é¢" loading="lazy"></div>
          ${t.note ? `<p style="margin-top:8px">${t.note}</p>` : ''}
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
            <button class="btn" data-view="${t.id}">æŸ¥çœ‹ç…§ç‰‡ï¼ˆ${(t.gallery||[]).length || 1}ï¼‰</button>
          </div>
        `;
        wrap.appendChild(art);
      });

      if(rebuildAnchors){ updateYearRailActive(); }
    }
    render(true);

    // ==== 5) æ—¶é—´è½´æ»šåŠ¨é«˜äº®ï¼ˆIntersectionObserverï¼‰====
    const yearAnchors = () => Array.from(document.querySelectorAll('[data-year-anchor]'));
    function updateYearRailActive(activeYear){
      const pills = Array.from(yearRail.querySelectorAll('.year-pill'));
      pills.forEach(p=>p.classList.toggle('active', p.dataset.year===activeYear));
    }
    const io = new IntersectionObserver(entries=>{
      const visible = entries.filter(e=>e.isIntersecting).sort((a,b)=> a.boundingClientRect.top - b.boundingClientRect.top);
      if(visible[0]){
        const y = visible[0].target.getAttribute('data-year-anchor');
        updateYearRailActive(y);
      }
    }, {rootMargin:"-64px 0px -70% 0px", threshold: [0,1]});
    function observeYears(){
      io.disconnect();
      yearAnchors().forEach(el=> io.observe(el));
    }
    observeYears();

    // ==== 6) ç¯ç®± ====
    const dlg=document.getElementById('dlg'), big=document.getElementById('big'), closeBtn=document.getElementById('closeBtn');
    let currentPhotos=[], currentIndex=-1;
    document.getElementById('timeline').addEventListener('click', (e)=>{
      const btn=e.target.closest('button[data-view]'); if(!btn) return;
      const id=btn.dataset.view; const trip=TRIPS.find(x=>x.id===id); if(!trip) return;
      currentPhotos=[trip.cover, ...(trip.gallery||[])].filter(Boolean); currentIndex=0;
      showPhoto(currentIndex);
      if(typeof dlg.showModal==='function'){ dlg.showModal(); } else { alert('æµè§ˆå™¨ä¸æ”¯æŒ <dialog>'); }
    });
    function showPhoto(i){ const src=currentPhotos[i]||''; big.src=src; big.alt='æ—…è¡Œç…§ç‰‡ '+(i+1); }
    closeBtn.addEventListener('click', ()=> dlg.close());
    dlg.addEventListener('close', ()=> { big.src=''; currentPhotos=[]; currentIndex=-1; });
    addEventListener('keydown', (e)=>{
      if(!dlg.open) return;
      if(e.key==='ArrowRight'){ e.preventDefault(); currentIndex=(currentIndex+1)%currentPhotos.length; showPhoto(currentIndex); }
      if(e.key==='ArrowLeft'){ e.preventDefault(); currentIndex=(currentIndex-1+currentPhotos.length)%currentPhotos.length; showPhoto(currentIndex); }
      if(e.key==='Escape'){ dlg.close(); }
    });

    // ==== 7) å¯¼å…¥/å¯¼å‡º ====
    const exportBtn=document.getElementById('exportBtn'), importFile=document.getElementById('importFile');
    exportBtn.addEventListener('click', ()=>{
      const blob=new Blob([JSON.stringify(TRIPS,null,2)], {type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='trips.json'; a.click(); URL.revokeObjectURL(url);
    });
    importFile.addEventListener('change', async ()=>{
      const f=importFile.files[0]; if(!f) return;
      try{
        const text=await f.text(); const data=JSON.parse(text);
        if(!Array.isArray(data)) throw new Error('JSON å¿…é¡»æ˜¯æ•°ç»„');
        data.forEach(x=>{
          if(!x.id || !x.date || !x.title || !x.scope) throw new Error('ç¼ºå°‘å¿…å¡«å­—æ®µ id/date/title/scope');
          if(x.scope!=='å›½å†…' && x.scope!=='å›½å¤–') throw new Error('scope åªèƒ½æ˜¯ â€œå›½å†…â€ æˆ– â€œå›½å¤–â€');
          if(x.scope==='å›½å†…' && !x.province) throw new Error('å›½å†…è®°å½•å¿…é¡»æä¾› provinceï¼ˆçœä»½ï¼‰');
        });
        // æ›¿æ¢æ•°æ®
        TRIPS.splice(0, TRIPS.length, ...data);
        // é‡å»ºå¹´ä»½/çœä»½/æ—¶é—´è½´
        const ys = Array.from(new Set(TRIPS.map(t=>t.date.slice(0,7)))).sort((a,b)=>b-a);
        years.splice(0, years.length, ...ys);
        yearSel.innerHTML = '<option value="all">å…¨éƒ¨å¹´ä»½</option>';
        years.forEach(y=>{ const opt=document.createElement('option'); opt.value=y; opt.textContent=y; yearSel.appendChild(opt); });
        buildProvinces(); buildYearRail();
        state.year='all'; state.scope='å…¨éƒ¨'; state.province='å…¨éƒ¨'; state.q='';
        document.getElementById('q').value='';
        scopeWrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        scopeWrap.querySelector('[data-scope="å…¨éƒ¨"]')?.classList.add('active');
        provBar.hidden = true;
        render(true); observeYears();
        alert('å¯¼å…¥æˆåŠŸï¼');
      }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
      finally{ importFile.value=''; }
    });
  </script>
</body>
</html>

